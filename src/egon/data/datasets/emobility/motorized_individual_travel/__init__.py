"""
Motorized Individual Travel (MIT)
"""

from pathlib import Path
from urllib.request import urlretrieve
import os

import numpy as np
import pandas as pd

from egon.data import db, subprocess
from egon.data.datasets import Dataset
from egon.data.datasets.emobility.motorized_individual_travel.db_classes import (
    EgonEvCountMunicipality,
    EgonEvCountMvGridDistrict,
    EgonEvCountRegistrationDistrict,
    EgonEvPool,
    EgonEvTrip,
    EgonEvMvGridDistrict
)
from egon.data.datasets.emobility.motorized_individual_travel.ev_allocation import (
    allocate_evs_numbers,
    allocate_evs_to_grid_districts
)
from egon.data.datasets.emobility.motorized_individual_travel.helpers import (
    COLUMNS_KBA,
    DOWNLOAD_DIRECTORY,
    TESTMODE_OFF,
    TRIP_COLUMN_MAPPING,
)
import egon.data.config


def create_tables():
    """Create tables for electric vehicles

    Returns
    -------
    None
    """

    engine = db.engine()
    EgonEvCountRegistrationDistrict.__table__.drop(
        bind=engine, checkfirst=True
    )
    EgonEvCountRegistrationDistrict.__table__.create(
        bind=engine, checkfirst=True
    )
    EgonEvCountMunicipality.__table__.drop(bind=engine, checkfirst=True)
    EgonEvCountMunicipality.__table__.create(bind=engine, checkfirst=True)
    EgonEvCountMvGridDistrict.__table__.drop(bind=engine, checkfirst=True)
    EgonEvCountMvGridDistrict.__table__.create(bind=engine, checkfirst=True)
    EgonEvPool.__table__.drop(bind=engine, checkfirst=True)
    EgonEvPool.__table__.create(bind=engine, checkfirst=True)
    EgonEvTrip.__table__.drop(bind=engine, checkfirst=True)
    EgonEvTrip.__table__.create(bind=engine, checkfirst=True)
    EgonEvMvGridDistrict.__table__.drop(bind=engine, checkfirst=True)
    EgonEvMvGridDistrict.__table__.create(bind=engine, checkfirst=True)


def download_and_preprocess():
    """Downloads and preprocesses data from KBA and BMVI

    Returns
    -------
    pandas.DataFrame
        Vehicle registration data for registration district
    pandas.DataFrame
        RegioStaR7 data
    """

    mit_sources = egon.data.config.datasets()["emobility_mit"][
        "original_data"
    ]["sources"]

    # Create the folder, if it does not exists
    if not os.path.exists(DOWNLOAD_DIRECTORY):
        os.mkdir(DOWNLOAD_DIRECTORY)

    ################################
    # Download and import KBA data #
    ################################
    url = mit_sources["KBA"]["url"]
    file = DOWNLOAD_DIRECTORY / mit_sources["KBA"]["file"]
    if not os.path.isfile(file):
        urlretrieve(url, file)

    kba_data = pd.read_excel(
        file,
        sheet_name=mit_sources["KBA"]["sheet"],
        usecols=mit_sources["KBA"]["columns"],
        skiprows=mit_sources["KBA"]["skiprows"],
    )
    kba_data.columns = COLUMNS_KBA
    kba_data.replace(
        " ",
        np.nan,
        inplace=True,
    )
    kba_data = kba_data.dropna()
    kba_data[
        ["ags_reg_district", "reg_district"]
    ] = kba_data.reg_district.str.split(
        " ",
        1,
        expand=True,
    )
    kba_data.ags_reg_district = kba_data.ags_reg_district.astype("int")

    kba_data.to_csv(
        DOWNLOAD_DIRECTORY / mit_sources["KBA"]["file_processed"], index=None
    )

    #######################################
    # Download and import RegioStaR7 data #
    #######################################

    url = mit_sources["RS7"]["url"]
    file = DOWNLOAD_DIRECTORY / mit_sources["RS7"]["file"]
    if not os.path.isfile(file):
        urlretrieve(url, file)

    rs7_data = pd.read_excel(file, sheet_name=mit_sources["RS7"]["sheet"])

    rs7_data["ags_district"] = (
        rs7_data.gem_20.multiply(1 / 1000).apply(np.floor).astype("int")
    )
    rs7_data = rs7_data.rename(
        columns={"gem_20": "ags", "RegioStaR7": "rs7_id"}
    )
    rs7_data.rs7_id = rs7_data.rs7_id.astype("int")

    rs7_data.to_csv(
        DOWNLOAD_DIRECTORY / mit_sources["RS7"]["file_processed"], index=None
    )


def write_evs_trips_to_db():
    """Write EVs and trips generated by simBEV from data bundle to database
    table
    """

    def import_csv(f):
        df = pd.read_csv(f, usecols=TRIP_COLUMN_MAPPING.keys())
        df["rs7_id"] = int(f.parent.name)
        df["simbev_ev_id"] = "_".join(f.name.split("_")[0:3])
        return df

    trip_dir_root = Path(
        ".", "data_bundle_egon_data", "emobility", "mit_trip_data"
    )

    if TESTMODE_OFF:
        trip_files = list(trip_dir_root.glob("*/*.csv"))
    else:
        # Load only 1000 EVs per region if in test mode
        trip_files = [
            list(rdir.glob("*.csv"))[:1000]
            for rdir in [_ for _ in trip_dir_root.iterdir() if _.is_dir()]
        ]
        # Flatten
        trip_files = [i for sub in trip_files for i in sub]

    # Read, concat and reorder cols
    print(f"Importing {len(trip_files)} EV trip CSV files...")
    trip_data = pd.concat(map(import_csv, trip_files))
    trip_data.rename(columns=TRIP_COLUMN_MAPPING, inplace=True)
    trip_data = trip_data.reset_index().rename(
        columns={"index": "simbev_event_id"}
    )
    cols = (["rs7_id", "simbev_ev_id", "simbev_event_id"] +
            list(TRIP_COLUMN_MAPPING.values()))
    trip_data.index.name = "event_id"
    trip_data = trip_data[cols]

    # Extract EVs from trips
    evs_unique = trip_data[["rs7_id", "simbev_ev_id"]].drop_duplicates()
    evs_unique = evs_unique.reset_index().drop(columns=["event_id"])
    evs_unique.index.name = "ev_id"

    # Add EV id to trip DF
    trip_data["egon_ev_pool_ev_id"] = pd.merge(
        trip_data, evs_unique.reset_index(),
        on=["rs7_id", "simbev_ev_id"])["ev_id"]

    # Split simBEV id into type and id
    evs_unique[["type", "simbev_ev_id"]] = evs_unique[
        "simbev_ev_id"].str.rsplit("_", 1, expand=True)
    evs_unique.simbev_ev_id = evs_unique.simbev_ev_id.astype(int)

    trip_data.drop(columns=["rs7_id", "simbev_ev_id"], inplace=True)
    trip_data.sort_index(inplace=True)

    # Write EVs to DB
    print("Writing EVs to DB pool...")
    evs_unique.to_sql(
        name=EgonEvPool.__table__.name,
        schema=EgonEvPool.__table__.schema,
        con=db.engine(),
        if_exists="append",
        index=True,
    )

    # Write trips to CSV and import to DB
    print("Writing EV trips to CSV file...")
    trip_file = "trip_data.csv"
    trip_data.to_csv(trip_file)

    # Get DB config
    docker_db_config = db.credentials()
    host = ["-h", f"{docker_db_config['HOST']}"]
    port = ["-p", f"{docker_db_config['PORT']}"]
    pgdb = ["-d", f"{docker_db_config['POSTGRES_DB']}"]
    user = ["-U", f"{docker_db_config['POSTGRES_USER']}"]
    command = [
        "-c",
        rf"\copy {EgonEvTrip.__table__.schema}.{EgonEvTrip.__table__.name}"
        rf"({','.join(trip_data.reset_index().columns)})"
        rf" FROM '{trip_file}' DELIMITER ',' CSV HEADER;",
    ]

    print("Importing EV trips from CSV file to DB...")
    subprocess.run(
        ["psql"] + host + port + pgdb + user + command,
        env={"PGPASSWORD": docker_db_config["POSTGRES_PASSWORD"]},
    )

    os.remove(trip_file)


class MotorizedIndividualTravel(Dataset):
    def __init__(self, dependencies):
        super().__init__(
            name="MotorizedIndividualTravel",
            version="0.0.0.dev",
            dependencies=dependencies,
            tasks=(
                create_tables,
                {(download_and_preprocess, allocate_evs_numbers),
                 write_evs_trips_to_db},
                allocate_evs_to_grid_districts
            ),
        )
